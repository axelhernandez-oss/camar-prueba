<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASISTENCIA HH</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 400px; margin: auto; }
        video { width: 100%; border-radius: 10px; background: #000; transform: scaleX(-1); margin-bottom: 10px; }
        
        /* BOTONES */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 12px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; display: block; }
        .entrada { background: #28a745; border-bottom: 4px solid #1e7e34; }
        .salida { background: #007bff; border-bottom: 4px solid #0056b3; }
        .btn:active { transform: translateY(2px); border-bottom: none; }
        
        #status { margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h2>CONTROL DE ASISTENCIA</h2>
    <p>ID EMPLEADO: <b id="displayId">Cargando...</b></p>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <button id="btnEntrada" class="btn entrada" onclick="enviarRegistro('ENTRADA')">REGISTRAR ENTRADA</button>
    <button id="btnSalida" class="btn salida" onclick="enviarRegistro('SALIDA')">REGISTRAR SALIDA</button>
    
    <div id="status"></div>
</div>

<script>
    // 1. TU URL DE GOOGLE APPS SCRIPT
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby0xPIwIoBHs1SmGcPoXRLe7pLMTWJPHSu3y94mrYFkrNDxi2dEPrdH4Lc0BicJpHaMww/exec";

    // 2. OBTENER ID DE LA URL
    const params = new URLSearchParams(window.location.search);
    const idEmpleado = params.get('id');
    document.getElementById('displayId').innerText = idEmpleado || "ERROR: SIN ID";

    // 3. INICIAR VIDEO
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { document.getElementById('video').srcObject = stream; })
        .catch(err => { alert("Por favor activa la cámara"); });

    // 4. FUNCIÓN DE ENVÍO
    function enviarRegistro(tipo) {
        const btnE = document.getElementById('btnEntrada');
        const btnS = document.getElementById('btnSalida');
        const status = document.getElementById('status');

        // Bloquear botones
        btnE.disabled = true;
        btnS.disabled = true;
        status.innerText = "⏳ ENVIANDO " + tipo + "...";
        status.style.background = "#fff3cd";

        navigator.geolocation.getCurrentPosition(pos => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            const datos = {
                id: idEmpleado,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                foto: canvas.toDataURL('image/png'),
                tipo: tipo // Aquí manda "ENTRADA" o "SALIDA"
            };

            fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(datos)
            })
            .then(() => {
                status.innerText = "✅ " + tipo + " REGISTRADA";
                status.style.background = "#d4edda";
                status.style.color = "#155724";
                // Ocultar botones después del éxito
                btnE.style.display = "none";
                btnS.style.display = "none";
            })
            .catch(err => {
                status.innerText = "❌ ERROR DE CONEXIÓN";
                btnE.disabled = false;
                btnS.disabled = false;
            });

        }, err => {
            alert("Debes activar el GPS para registrar tu asistencia.");
            btnE.disabled = false;
            btnS.disabled = false;
        });
    }
</script>

</body>
</html>
